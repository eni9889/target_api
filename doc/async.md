## Асинхронный API

Асинхронный API предоставляет возможность поставить запрос к обычному API
в очередь на выполнение. Когда запрос будет выполнен получить
его результаты можно будет отдельным запросом. Факт выполнения запроса можно
определить, отправляя постоянные запросы для проверки статуса, или же указать
в изначальном запросе URL для вызова уведомления о выполнении запроса.

Преимущество асинхронного API над обычным в том, что на него не
распространяются ограничения на количество запросов. Все отправленные запросы
будут выполнены.

### Отправка запроса

Для того, чтобы отправить асинхронный запрос к API, достаточно всего лишь
заменить в URL-адресе вызова `/api/` на `/async_api/`:

    POST /async_api/v2/campaigns.json HTTP/1.1
    Host: target.my.com
    Authorization: Bearer {oauth2_access_token}
    X-Callback-Location: http://client.com/callback
    X-Callback-Method: GET

    {JSON data}

HTTP-Заголовок `X-Callback-Location` не обязателен. Он сообщает асинхронному
API, что необходимо вызвать переданный в нём URL-адрес после выполнения
запроса. Необязательный же заголовок `X-Callback-Method` укажет, каким
HTTP-методом должен быть сделан вызов (по умолчанию это `POST`, также можно
указать значение `GET`). В параметрах вызова (в теле запроса в случае `POST` и
в виде query-string параметров в случае `GET`) будут переданы:

* `response_id` — идентификатор исходного запроса к асинхронному API;
* `response_url` — URL-адрес, по которому доступен ответ от Target API;
* `response_http_code` — HTTP-статус ответа Target API;

Ответ на успешный запрос к асинхронному API выглядит следующим образом:

    HTTP/1.1 202 Accepted
    Location: /async_api/v2/requests/{id}.json

Это означает, что запрос был успешно поставлен в очередь с идентификатором `id`.
HTTP-заголовок `Location` содержит URL-адрес для получения статуса запроса.

### Получение статуса запроса

После постановки запроса в очередь, в любой момент можно проверить статус
запроса, обратившись по URL-адресу из заголовка `Location` ответа на запрос к
асинхронному API:

    GET /async_api/v2/requests/{id}.json HTTP/1.1
    Authorization: Bearer {oauth2_access_token}
    Host: target.my.com

Пример ответа:

    HTTP/1.1 200 Ok
    Content-Type: application/json

    {
      "id": "123",
      "status": "enqueued",
      "created": "2014-03-05 23:50:38"
    }

Или же, если запрос был уже выполнен:

    HTTP/1.1 303 See Other
    Location: /async_api/v2/responses/{id}.json
    Content-Type: application/json

    {
      "id": "{id}",
      "status": "done",
      "response_http_code": 400,
      "response_url": "/async_api/v2/responses/{id}.json",
      "started": "2014-03-05 23:57:23",
      "exec_time": 125,
      "created": "2014-03-05 23:50:38"
    }

В HTTP-заголовке `Location` или поле `response_url` такого ответа (статус 303,
`status` — `done`) содержится URL-адрес, по которому можно получить результат
выполнения запроса с сохранением всех HTTP-заголовков оригинального ответа
API.

#### Статусы запросов

Статус запроса может принимать следующие значения:

* `enqueued` — запрос поставлен в очередь;
* `started` — запрос отправлен, но ответ ещё не получен;
* `done` — запрос выполнен;
* `unknown` — такой статус выставляется запросу в том случае, если после
  отправки запроса произошла авария и асинхронный API не успел обработать ответ
  от API — все такие случаи необходимо разбирать в ручном режиме.

Выполненные запросы доступны в течение суток, после чего они удаляются из
хранилища асинхронного API.
